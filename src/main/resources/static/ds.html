<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <!-- 引入 WeUI -->
    <title>董事咨询建议表</title>
    <script type="text/javascript" src="../../js/axios.min.js" >></script>

    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/2.4.0/weui.min.css">
    <script type="text/javascript" src="https://res.wx.qq.com/open/libs/weuijs/1.2.1/weui.min.js"></script>
    <script src="../../js/util.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>
    <link rel="stylesheet" href="../../css/global.css" />
    <link rel="stylesheet" href="http://at.alicdn.com/t/font_1922682_b0autjedml9.css" />
</head>
<style>
    html,body{
        padding:0;
        margin: 0;
        box-sizing: border-box;
    }
    label{
        padding:0
    }
    .weui-label{
        font-size: 85%;
        min-width: max-content;
    }
    .weui-cell__bd {
        -webkit-box-flex: 1;
        -webkit-flex: 1;
        flex: 1;
        font-size: 85%;
    }
    .weui-form{
        padding-top:0;
    }
    .weui-form__text-area{
        margin-top: 2%;
    }
</style>
<body>
<!-- 使用 WeUI -->
<div class="page">
    <div class="weui-form">
        <div class="weui-form__text-area">
            <h2 class="weui-form__title">董事咨询建议表</h2>
        </div>
        <div class="weui-form__control-area" id="form">
            <div class="weui-cells__group weui-cells__group_form">
                <div class="weui-cells weui-cells_form">
                    <div class="weui-cell weui-cell_active">
                        <div class="weui-cell__hd"><label class="weui-label"> <i class="icon iconfont icon-bitian1" style="color:red;"></i>董事姓名</label></div>
                        <div class="weui-cell__bd">
                            <input class="weui-input name" placeholder="请填写董事姓名" required />
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_active">
                        <div class="weui-cell__hd"><label class="weui-label"> <i class="icon iconfont icon-bitian1" style="color: #ffffff;"></i>职务</label></div>
                        <div class="weui-cell__bd">
                            <input class="weui-input job" placeholder="请填写职务" />
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_active">
                        <div class="weui-cell__hd"><label class="weui-label"> <i class="icon iconfont icon-bitian1" style="color: red;"></i>董事单位</label></div>
                        <div class="weui-cell__bd">
                            <input class="weui-input uint" required placeholder="请填写董事单位" />
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_active">
                        <div class="weui-cell__hd"><label class="weui-label"> <i class="icon iconfont icon-bitian1" style="color: red;"></i>手机</label></div>
                        <div class="weui-cell__bd">
                            <input class="weui-input phone" type="tel" required pattern="REG_tel" maxlength="11" placeholder="请输入手机号"
                                   emptyTips="请输入手机号" notMatchTips="请输入正确的手机号">
                        </div>
                        <div class="weui-cell__ft">
                            <i class="weui-icon-warn"></i>
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_active">
                        <div class="weui-cell__hd"><label class="weui-label"> <i class="icon iconfont icon-bitian1" style="color:  #ffffff;"></i>邮箱</label></div>
                        <div class="weui-cell__bd">
                            <input class="weui-input email" type="email" pattern="REG_email" placeholder="请输入邮箱" notMatchTips="请输入正确的邮箱"
                                   required />
                        </div>
                    </div>
                    <div class="weui-cell weui-cell_active">
                        <div class="weui-cell__hd"><label class="weui-label"> <i class="icon iconfont icon-bitian1" style="color: red;"></i>咨询建议</label></div>
                        <div class="weui-cell__bd">
                            <input type="text" class="weui-textarea adviance" maxlength="500" placeholder="请描述你所的咨询建议" rows="3" />
                            <div class="weui-textarea-counter"><span>0</span>/500</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="weui-form__opr-area">
            <a class="weui-btn weui-btn_primary " id="formSubmitBtn" href="javascript:">确定</a>
        </div>
        <div class="weui-form__extra-area">
            <div class="weui-footer">
                <p class="weui-footer__links">
                    <a href="javascript:" class="weui-footer__link">重庆邮电大学董事处</a>
                </p>
                <p class="weui-footer__text">Copyright © 2020</p>
            </div>
        </div>
    </div>

</div>
<script type="text/javascript">
    //向后端发送数据请求
    function postMess() {
        var message = {};
        //董事name,职务job,单位uint,手机phone,email,建议adviance
        message.author = $('.name')[0].value;
        message.job = $('.job')[0].value;
        message.cidname = $('.uint')[0].value;
        message.tel = $('.phone')[0].value;
        message.email = $('.email')[0].value;
        message.content = $('.adviance')[0].value;
        message.type = 0;
        let mess = JSON.stringify(message)
        $.ajax({
            type: 'POST',
            //这里是提交董事需求建议的新数据
            url: '../../json/w.json',
            data: mess,
            contentType: "application/json; charset=utf-8",
            success: (function(res) {
                if (res.code == 0) {
                    weui.toast('提交成功', 3000);
                } else if (res == 1001) {
                    weui.alert(res.message)
                } else if (res == 30001) {
                    weui.alert(res.message)
                } else if (res == 30012) {
                    weui.alert(res.message)
                } else if (res == 30011) {
                    weui.alert(res.message)
                } else {
                    weui.alert("未知错误")
                }
            }),
            error: (function(res) {
                var resp = res.responseText;
                var reg = /<pre.+?>(.+)<\/pre>/g;
                var result = resp.match(reg);
                console.log(11, res, result);
                weui.alert('提交失败')
            }),


        });
    }
    //表单正则
    var regexp = {
        regexp: {
            tel: /^((0\d{2,3}-\d{7,8})|(1[3584]\d{9}))$/,
            email: /(^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+)|(^$)/,
        }
    };
    weui.form.checkIfBlur('#form', regexp);
    document.querySelector('#formSubmitBtn').addEventListener('click', function() {
        weui.form.validate('#form', function(error) {
            console.log(error);
            if (!error) {
                postMess()
            }
        }, regexp);
    });

    //如果是点击查看详情页面,刚进来就要加载数据
    $(function() {
        var url = window.location.search;
        var urlPa = getUrlParam(url);
        if ('id' in urlPa) {
            //给所有的input加一个disable属性
            $("input").attr("disabled", true);
            //将button的属性成不能提交
            $("#formSubmitBtn").addClass("weui-btn_disabled")
            //将数字的范围去掉
            $(".weui-textarea-counter").each(
                function() {
                    $(this).css("display", "none");
                }
            );
            //将请详细填写的也去掉
            $(".weui-form__tips").each(
                function() {
                    $(this).css("display", "none");
                }
            );
            //将确定按钮去掉
            $("#formSubmitBtn").css("display", "none");
            //发送ajax请求获取数据
            //根据id获取data值,并且将值渲染到页面
            $.ajax({
                type: 'get',
                //这里是获取特定id董事需求建议的数据
                data: urlPa.id,
                url: '../../json/w.json',
                success: (function(res) {
                    if (res.code == 0) {
                        $(".name")[0].value = data[0].author;
                        $(".job")[0].value = data[0].job;
                        $(".uint")[0].value = data[0].cidname;
                        $(".phone")[0].value = data[0].tel;
                        $(".email")[0].value = data[0].email;
                        $(".adviance")[0].value = data[0].content;
                    } else if (res == 1001) {
                        weui.alert(res.message)
                    } else if (res == 30001) {
                        weui.alert(res.message)
                    } else if (res == 30012) {
                        weui.alert(res.message)
                    } else if (res == 30011) {
                        weui.alert(res.message)
                    } else {
                        weui.alert("未知错误")
                    }
                }),

                error: (function() {
                    weui.alert('该条数据获取失败')
                })
            });
        } else return;
    })

    //对url进行解析,得到一个参数数组
    function getUrlParam(url) {
        var params = {};
        var search = url;
        search = /\?/.test(search) && search.split("?")[1];
        var searchs = /\&/.test(search) ? search.split("&") : [search];
        for (var i = 0; i < searchs.length; i++) {
            if (/\=/.test(searchs[i])) {
                var item = searchs[i].split("=");
                params[item[0]] = item[1];
            };
        };
        return params;
    };
</script>
</body>
</html>
